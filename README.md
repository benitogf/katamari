# SAMO

[![Build Status][build-image]][build-url]


[build-url]: https://travis-ci.org/benitogf/samo
[build-image]: https://api.travis-ci.org/benitogf/samo.svg?branch=master&style=flat-square

pub/sub (websocket) and http service for leveldb storage

| method | description | url    |
| ------------- |:-------------:| -----:|
| GET | key list | http://{host}:{port} |
| DEL | del | http://{host}:{port}/r/{key} |

## time

server side time ticker. will send a new timestamp per second

| method | description | url    |
| ------------- |:-------------:| -----:|
| websocket| time ticker | ws://{host}:{port}/time |

## single allocation (SA)

will handle the key as key->value

| method | description | url    |
| ------------- |:-------------:| -----:|
| websocket| key data events: update, delete | ws://{host}:{port}/sa/{key} |
| POST | create/update | http://{host}:{port}/r/sa |
| GET | get object | http://{host}:{port}/r/sa/{key} |

### websocket

### get (sent after handshake and on each new/update/delete event)
---
```js
{
    created: 0,
    updated: 0,
    index: '',
    data: 'e30='
}
```

### set (format expected from client)
---
```js
{
    data: 'e30='
}
```

## multiple objects (MO)

    will handle the key as a list of every key/[index...] (or key/*), excluding the empty index (key->value)

| method  | description | url    |
| ------------- |:-------------:| -----:|
| websocket | key data events: new, update, delete | ws://{host}:{port}/mo/{key} |
| POST | create/update, if the index is not provided it will autogenerate a new one, preexistent data on the provided key/index will be overwriten | http://{host}:{port}/r/mo |
| GET | get list | http://{host}:{port}/r/mo/{key} |

### websocket

### get (sent after handshake and on each new/update/delete event)
---
```js
[
    {
        created: 1546660572033308700,
        updated: 0,
        index: '1576d7988025d81c0',
        data: 'e30='
    }
    ...
]
```

### create/update (format expected from client)
    the index field is optional, will be autogenerated if its empty/null.
---
```js
{
    index: 'test',
    data: 'e30='
}
```

### delete (format expected from client)
---
```js
{
    op: 'DEL',
    index: 'test'
}
```

## Data archetypes and audit

    Define ad lib custom acceptance criteria of data using key glob patterns and audit middleware

```go
package main

import (
	"net/http"

	"github.com/benitogf/samo"
)

func main() {
	app := samo.Server{}
	app.Archetypes = samo.Archetypes{
		"things/*": func(data string) bool {
			return data == "object"
		},
		"bag": func(data string) bool {
			return data == "marbles"
		},
	}
	app.Audit = func(r *http.Request) bool {
		return r.Method == "GET" && r.Header.Get("Upgrade") != "websocket"
	}
	app.Start("localhost:8800", "data/db", '/')
	app.WaitClose()
}
```
